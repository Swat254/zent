<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Zent Finance - Secure Mobile Trading</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        :root {
            --primary: #004321;
            --secondary: #8BC34A;
            --background: #FFFFFF;
            --background-alt: #F8F9FA;
            --accent-navy: #003366;
            --accent-turquoise: #40E0D0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-alt);
            color: var(--text-primary);
            max-width: 480px;
            margin: 0 auto;
            position: relative;
            min-height: 100vh;
        }

        .container {
            padding: 16px;
            padding-bottom: 80px;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--accent-navy));
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .logo-text {
            font-weight: bold;
            font-size: 1.3rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .header-icon {
            font-size: 1.2rem;
            cursor: pointer;
        }

        .card {
            background: var(--background);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--accent-navy));
            color: white;
            text-align: center;
            padding: 25px 20px;
            position: relative;
            overflow: hidden;
        }

        .balance-label {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .balance-amount {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .profit-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .action-btn {
            background: var(--background);
            border: none;
            border-radius: var(--border-radius);
            padding: 15px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .action-btn:hover {
            transform: translateY(-3px);
        }

        .action-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .action-label {
            font-size: 0.8rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .investment-plans {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .plan-card {
            border: 1px solid #eaeaea;
            border-radius: var(--border-radius);
            padding: 20px;
            position: relative;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .plan-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .plan-apy {
            background: var(--secondary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .plan-minimum {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .invest-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 16px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }

        .invest-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            display: flex;
            align-items: center;
        }

        .transaction-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--background-alt);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: var(--primary);
        }

        .transaction-details {
            display: flex;
            flex-direction: column;
        }

        .transaction-title {
            font-weight: 500;
        }

        .transaction-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .transaction-amount {
            font-weight: 600;
        }

        .amount-positive {
            color: var(--success);
        }

        .amount-negative {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 14px 16px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            position: relative;
        }

        .btn-primary:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 480px;
            margin: 0 auto;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            flex: 1;
            padding: 5px 0;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }

        .auth-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent-navy));
        }

        .auth-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .auth-logo .logo {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }

        .auth-logo .logo-text {
            font-size: 1.8rem;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-top: 10px;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
        }

        .auth-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            display: flex;
            align-items: center;
            max-width: 90%;
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-16 {
            margin-top: 16px;
        }

        .p-16 {
            padding: 16px;
        }

        .account-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .account-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            cursor: pointer;
            position: relative;
        }

        .account-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--background-alt);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary);
            overflow: hidden;
        }

        .profile-picture {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .account-details {
            flex: 1;
        }

        .account-title {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kyc-badge {
            background: var(--success);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .verified-tick {
            color: var(--success);
            font-size: 0.9rem;
        }

        .account-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .support-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .support-option {
            background: var(--background);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        .support-icon {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .faq-item {
            margin-bottom: 16px;
            border: 1px solid #eaeaea;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .faq-question {
            padding: 16px;
            background: var(--background);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .faq-answer {
            padding: 0 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            background: var(--background-alt);
        }

        .faq-item.active .faq-answer {
            padding: 16px;
            max-height: 500px;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--background);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .user-welcome {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .download-app {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary), var(--accent-navy));
            color: white;
            border-radius: var(--border-radius);
            text-decoration: none;
            margin-top: 20px;
            transition: transform 0.3s;
        }

        .download-app:hover {
            transform: translateY(-2px);
        }

        /* NEW STYLES FOR REFRESH BUTTON */
        .refresh-btn {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 10px;
            transition: transform 0.3s;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
        }

        /* NEW STYLES FOR SURVEY SECTION */
        .survey-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .survey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .survey-title {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .survey-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .survey-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .survey-stat {
            text-align: center;
        }

        .survey-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .survey-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .survey-actions {
            display: flex;
            gap: 10px;
        }

        .survey-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: var(--border-radius);
            padding: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .survey-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .survey-btn.primary {
            background: white;
            color: #667eea;
        }

        .survey-btn.primary:hover {
            background: #f8f9fa;
        }

        .survey-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .premium-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .survey-container {
            margin-top: 20px;
            border: 1px solid #eaeaea;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .survey-iframe {
            width: 100%;
            height: 500px;
            border: none;
        }

        /* NEW STYLES FOR PREMIUM PAYMENT OPTIONS */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-option.selected {
            border-color: var(--primary);
            background-color: rgba(0, 67, 33, 0.05);
        }

        .payment-option input {
            margin-right: 10px;
        }

        .payment-label {
            display: flex;
            flex-direction: column;
        }

        .payment-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .payment-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* NEW STYLES FOR ENHANCED DASHBOARD */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: var(--background);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-item-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-item-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-item-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .app-download-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .app-download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: var(--background);
            border-radius: var(--border-radius);
            text-decoration: none;
            color: var(--text-primary);
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .app-download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .app-download-icon {
            font-size: 1.5rem;
        }

        .app-download-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .app-download-title {
            font-weight: 600;
        }

        .app-download-subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .referral-code-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .referral-code-display {
            flex: 1;
            background: var(--background-alt);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Authentication Screens -->
    <div id="auth-screens">
        <!-- Login Screen -->
        <div id="login-screen" class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">
                        <div class="logo">Z</div>
                        <div class="logo-text">Zent Finance</div>
                    </div>
                    <div class="auth-subtitle">Sign in to your account</div>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label" for="login-email">Email</label>
                        <input type="email" id="login-email" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="login-password">Password</label>
                        <input type="password" id="login-password" class="form-input" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn-primary" id="login-btn">
                        <span id="login-btn-text">Sign In</span>
                        <span class="spinner hidden" id="login-spinner"></span>
                    </button>
                </form>
                <div class="auth-footer">
                    Don't have an account? <a href="#" class="auth-link" id="show-register">Sign Up</a>
                </div>
                <div class="auth-footer mt-16">
                    <a href="#" class="auth-link" id="show-forgot-password">Forgot Password?</a>
                </div>
            </div>
        </div>

        <!-- Registration Screen -->
        <div id="register-screen" class="auth-container hidden">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">
                        <div class="logo">Z</div>
                        <div class="logo-text">Zent Finance</div>
                    </div>
                    <div class="auth-subtitle">Create your account</div>
                </div>
                
                <form id="register-form">
                    <div class="form-group">
                        <label class="form-label" for="register-fullname">Full Name</label>
                        <input type="text" id="register-fullname" class="form-input" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-email">Email</label>
                        <input type="email" id="register-email" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-phone">Phone Number</label>
                        <input type="tel" id="register-phone" class="form-input" placeholder="07XXXXXXXX or 254XXXXXXXXX" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-password">Password</label>
                        <input type="password" id="register-password" class="form-input" placeholder="Create a password (min. 6 characters)" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-referral">Referral Code (Optional)</label>
                        <input type="text" id="register-referral" class="form-input" placeholder="Enter referral code">
                    </div>
                    <button type="submit" class="btn-primary" id="register-btn">
                        <span id="register-btn-text">Create Account</span>
                        <span class="spinner hidden" id="register-spinner"></span>
                    </button>
                </form>
                <div class="auth-footer">
                    Already have an account? <a href="#" class="auth-link" id="show-login">Sign In</a>
                </div>
            </div>
        </div>

        <!-- Forgot Password Screen -->
        <div id="forgot-password-screen" class="auth-container hidden">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">
                        <div class="logo">Z</div>
                        <div class="logo-text">Zent Finance</div>
                    </div>
                    <div class="auth-subtitle">Reset your password</div>
                </div>
                <form id="forgot-password-form">
                    <div class="form-group">
                        <label class="form-label" for="reset-email">Email</label>
                        <input type="email" id="reset-email" class="form-input" placeholder="Enter your email" required>
                    </div>
                    <button type="submit" class="btn-primary" id="reset-btn">
                        <span id="reset-btn-text">Send Reset Link</span>
                        <span class="spinner hidden" id="reset-spinner"></span>
                    </button>
                </form>
                <div class="auth-footer">
                    Remember your password? <a href="#" class="auth-link" id="show-login-from-forgot">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <header>
            <div class="logo-container">
                <div class="logo">Z</div>
                <div class="logo-text">Zent Finance</div>
            </div>
            <div class="header-actions">
                <i class="fas fa-bell header-icon" id="notification-icon"></i>
                <i class="fas fa-user-circle header-icon" id="user-icon"></i>
            </div>
        </header>

        <div class="container">
            <!-- Dashboard Screen -->
            <div id="dashboard-screen">
                <div class="balance-card card">
                    <div class="user-welcome">
                        <span class="user-name" id="welcome-name">Welcome, User</span>
                        <span class="verified-tick hidden" id="user-verified-tick"><i class="fas fa-check-circle"></i></span>
                        <button class="refresh-btn" id="refresh-balance-btn">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="balance-label">Total Balance</div>
                    <div class="balance-amount" id="total-balance">KES 0.00</div>
                    <div class="profit-indicator">
                        <i class="fas fa-chart-line"></i>
                        <span id="profit-text">+ KES 0.00 Today</span>
                    </div>
                </div>

                <!-- NEW: Enhanced Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-item-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-item-value" id="total-earnings">KES 0</div>
                        <div class="stat-item-label">Total Earnings</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="stat-item-value" id="active-investments-count">0</div>
                        <div class="stat-item-label">Active Investments</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-icon">
                            <i class="fas fa-poll"></i>
                        </div>
                        <div class="stat-item-value" id="survey-earnings">KES 0</div>
                        <div class="stat-item-label">Survey Earnings</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-item-value" id="referral-count">0</div>
                        <div class="stat-item-label">Referrals</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="action-btn" id="deposit-btn">
                        <div class="action-icon"><i class="fas fa-plus-circle"></i></div>
                        <div class="action-label">Deposit</div>
                    </div>
                    <div class="action-btn" id="withdraw-btn">
                        <div class="action-icon"><i class="fas fa-minus-circle"></i></div>
                        <div class="action-label">Withdraw</div>
                    </div>
                    <div class="action-btn" id="earn-btn">
                        <div class="action-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="action-label">Earn</div>
                    </div>
                    <div class="action-btn" id="account-btn">
                        <div class="action-icon"><i class="fas fa-user-circle"></i></div>
                        <div class="action-label">Account</div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Recent Transactions</div>
                        <a href="#" id="view-all-transactions" style="color: var(--primary); font-size: 0.9rem;">View All</a>
                    </div>
                    <div id="recent-transactions">
                        <div class="text-center p-16">No recent transactions</div>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Investment Plans</div>
                    </div>
                    <div class="investment-plans" id="investment-plans-container">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>

                <!-- NEW: App Download Section -->
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Download Our App</div>
                    </div>
                    <div class="app-download-section">
                        <a href="https://www.mediafire.com/folder/m3nvmpggaoq19/ZENT+APP" class="app-download-btn" target="_blank">
                            <div class="app-download-icon">
                                <i class="fab fa-android"></i>
                            </div>
                            <div class="app-download-text">
                                <div class="app-download-title">Download for Android</div>
                                <div class="app-download-subtitle">Get the full experience</div>
                            </div>
                        </a>
                        <a href="https://www.mediafire.com/file/atjdhnm529f6k68/ios_source.tar.gz/file" class="app-download-btn" target="_blank">
                            <div class="app-download-icon">
                                <i class="fab fa-apple"></i>
                            </div>
                            <div class="app-download-text">
                                <div class="app-download-title">Download for iOS</div>
                                <div class="app-download-subtitle">Optimized for iPhone</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Deposit Screen -->
            <div id="deposit-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Deposit Funds</div>
                    </div>
                    <form id="deposit-form">
                        <div class="form-group">
                            <label class="form-label" for="deposit-amount">Amount (KES)</label>
                            <input type="number" id="deposit-amount" class="form-input" placeholder="Minimum: KES 10" min="10" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Method</label>
                            <div style="display: flex; gap: 15px;">
                                <div style="display: flex; align-items: center;">
                                    <input type="radio" id="mpesa" name="payment-method" value="mpesa" checked>
                                    <label for="mpesa" style="margin-left: 5px;">M-Pesa</label>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <input type="radio" id="airtel" name="payment-method" value="airtel">
                                    <label for="airtel" style="margin-left: 5px;">Airtel Money</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn-primary" id="deposit-submit-btn">
                            <span id="deposit-btn-text">Proceed to Payment</span>
                            <span class="spinner hidden" id="deposit-spinner"></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Withdrawal Screen -->
            <div id="withdrawal-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Withdraw Funds</div>
                    </div>
                    <form id="withdrawal-form">
                        <div class="form-group">
                            <label class="form-label" for="withdrawal-amount">Amount (KES)</label>
                            <input type="number" id="withdrawal-amount" class="form-input" placeholder="Minimum: KES 100" min="100" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="withdrawal-phone">Phone Number</label>
                            <input type="tel" id="withdrawal-phone" class="form-input" placeholder="07XXXXXXXX or 254XXXXXXXXX" required>
                        </div>
                        <button type="submit" class="btn-primary" id="withdrawal-submit-btn">
                            <span id="withdrawal-btn-text">Submit Withdrawal Request</span>
                            <span class="spinner hidden" id="withdrawal-spinner"></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Earn Screen -->
            <div id="earn-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Investment Plans</div>
                    </div>
                    <div class="investment-plans" id="earn-plans-container">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Active Investments</div>
                    </div>
                    <div id="active-investments">
                        <div class="text-center p-16">No active investments</div>
                    </div>
                </div>

                <!-- NEW SURVEY SECTION -->
                <div class="survey-card">
                    <div class="survey-header">
                        <div class="survey-title">Earn with Surveys</div>
                        <div class="survey-badge">KES 20 per survey</div>
                    </div>
                    <div class="survey-stats">
                        <div class="survey-stat">
                            <div class="survey-stat-value" id="surveys-today">0/1</div>
                            <div class="survey-stat-label">Surveys Today</div>
                        </div>
                        <div class="survey-stat">
                            <div class="survey-stat-value" id="survey-earnings-total">KES 0</div>
                            <div class="survey-stat-label">Total Earnings</div>
                        </div>
                    </div>
                    <div class="survey-actions">
                        <button class="survey-btn" id="take-survey-btn" disabled>Take Survey</button>
                        <button class="survey-btn primary" id="buy-premium-btn">Buy Premium <span class="premium-badge">KES 120</span></button>
                    </div>
                </div>

                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Referral Program</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Referral Code</label>
                        <div class="referral-code-section">
                            <div class="referral-code-display" id="referral-code-display">ZENT123456</div>
                            <button type="button" class="copy-btn" id="copy-referral">Copy</button>
                        </div>
                    </div>
                    
                    <div class="referral-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="referrals-count">0</div>
                            <div class="stat-label">People Referred</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="referral-earnings">KES 0.00</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Screen -->
            <div id="account-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Account</div>
                    </div>
                    <div class="account-menu">
                        <div class="account-item" id="profile-item">
                            <div class="account-icon" id="profile-picture-container">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="account-details">
                                <div class="account-title" id="profile-title">
                                    Profile
                                    <span class="verified-tick hidden" id="profile-verified-tick"><i class="fas fa-check-circle"></i></span>
                                </div>
                                <div class="account-description">Manage your personal information</div>
                            </div>
                        </div>

                        <div class="account-item" id="kyc-item">
                            <div class="account-icon">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <div class="account-details">
                                <div class="account-title">
                                    KYC Verification
                                    <span class="verified-tick hidden" id="kyc-verified-tick"><i class="fas fa-check-circle"></i></span>
                                </div>
                                <div class="account-description">Verify your identity to enable withdrawals</div>
                            </div>
                        </div>

                        <div class="account-item" id="download-app-item">
                            <div class="account-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="account-details">
                                <div class="account-title">Download App</div>
                                <div class="account-description">Get our mobile app for better experience</div>
                            </div>
                        </div>

                        <div class="account-item" id="support-item">
                            <div class="account-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <div class="account-details">
                                <div class="account-title">Support</div>
                                <div class="account-description">Get help and contact customer service</div>
                            </div>
                        </div>

                        <div class="account-item" id="logout-item">
                            <div class="account-icon">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <div class="account-details">
                                <div class="account-title">Logout</div>
                                <div class="account-description">Sign out of your account</div>
                            </div>
                        </div>
                    </div>

                    <div class="app-download-section">
                        <a href="https://www.mediafire.com/folder/m3nvmpggaoq19/ZENT+APP" class="app-download-btn" target="_blank">
                            <div class="app-download-icon">
                                <i class="fab fa-android"></i>
                            </div>
                            <div class="app-download-text">
                                <div class="app-download-title">Download for Android</div>
                                <div class="app-download-subtitle">Get the full experience</div>
                            </div>
                        </a>
                        <a href="https://www.mediafire.com/file/atjdhnm529f6k68/ios_source.tar.gz/file" class="app-download-btn" target="_blank">
                            <div class="app-download-icon">
                                <i class="fab fa-apple"></i>
                            </div>
                            <div class="app-download-text">
                                <div class="app-download-title">Download for iOS</div>
                                <div class="app-download-subtitle">Optimized for iPhone</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Profile Information</div>
                    </div>
                    <form id="profile-form">
                        <div class="form-group">
                            <label class="form-label" for="profile-fullname">Full Name</label>
                            <input type="text" id="profile-fullname" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="profile-email">Email</label>
                            <input type="email" id="profile-email" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="profile-phone">Phone Number</label>
                            <input type="tel" id="profile-phone" class="form-input" placeholder="07XXXXXXXX or 254XXXXXXXXX" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="profile-picture">Profile Picture</label>
                            <input type="file" id="profile-picture" class="form-input" accept="image/*">
                        </div>
                        <button type="submit" class="btn-primary" id="profile-submit-btn">
                            <span id="profile-btn-text">Update Profile</span>
                            <span class="spinner hidden" id="profile-spinner"></span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- KYC Screen -->
            <div id="kyc-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">KYC Verification</div>
                    </div>
                    <div id="kyc-status" class="mb-16">
                        <!-- KYC status will be displayed here -->
                    </div>
                    
                    <!-- Show KYC form only if not verified -->
                    <div id="kyc-form-container">
                        <form id="kyc-form">
                            <div class="form-group">
                                <label class="form-label" for="kyc-id-type">ID Type</label>
                                <select id="kyc-id-type" class="form-input" required>
                                    <option value="">Select ID Type</option>
                                    <option value="national_id">National ID</option>
                                    <option value="passport">Passport</option>
                                    <option value="driving_license">Driving License</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="kyc-id-number">ID Number</label>
                                <input type="text" id="kyc-id-number" class="form-input" placeholder="Enter ID number" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="kyc-front">Front of ID</label>
                                <input type="file" id="kyc-front" class="form-input" accept="image/*" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="kyc-back">Back of ID</label>
                                <input type="file" id="kyc-back" class="form-input" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="kyc-selfie">Selfie with ID</label>
                                <input type="file" id="kyc-selfie" class="form-input" accept="image/*" required>
                            </div>
                            <button type="submit" class="btn-primary" id="kyc-submit-btn">
                                <span id="kyc-btn-text">Submit for Verification</span>
                                <span class="spinner hidden" id="kyc-spinner"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Support Screen -->
            <div id="support-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Support Center</div>
                    </div>
                    <p>How can we help you today?</p>
                    
                    <div class="support-options">
                        <div class="support-option" id="faq-option">
                            <div class="support-icon">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="support-title">FAQ</div>
                            <div class="support-description">Find answers to common questions</div>
                        </div>
                        
                        <div class="support-option" id="contact-option">
                            <div class="support-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="support-title">Contact Us</div>
                            <div class="support-description">Get in touch with our team</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Contact Information</div>
                    </div>
                    <div class="account-item">
                        <div class="account-icon">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="account-details">
                            <div class="account-title">WhatsApp</div>
                            <div class="account-description">+254 784 575 544</div>
                        </div>
                    </div>
                    
                    <div class="account-item">
                        <div class="account-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="account-details">
                            <div class="account-title">Email</div>
                            <div class="account-description">zentfinance@gmail.com</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAQ Screen -->
            <div id="faq-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Frequently Asked Questions</div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question">
                            How do I start investing with Zent Finance?
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            To start investing, simply register an account, complete KYC verification, deposit funds, and choose from our available investment plans. Minimum deposit is KES 10.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question">
                            What is the minimum investment amount?
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            Minimum investment amounts vary by asset: USDT (KES 100), Bitcoin (KES 500), Gold (KES 15,000), Coal (KES 20,000), GENZ (KES 200).
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW SURVEY SCREEN -->
            <div id="survey-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Take Survey</div>
                    </div>
                    <p>Complete this survey to earn KES 20. Please fill out the form completely and submit it.</p>
                    
                    <div class="survey-container">
                        <iframe id="survey-iframe" class="survey-iframe" src=""></iframe>
                    </div>
                    
                    <div class="form-group mt-16">
                        <button type="button" class="btn-primary" id="submit-survey-btn">
                            <span id="submit-survey-btn-text">I've Completed the Survey</span>
                            <span class="spinner hidden" id="submit-survey-spinner"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- NEW PREMIUM PAYMENT SCREEN -->
            <div id="premium-payment-screen" class="hidden">
                <div class="card">
                    <div class="section-header">
                        <div class="section-title">Buy Premium Subscription</div>
                    </div>
                    <p>Upgrade to Premium for only KES 120 and unlock up to 3 surveys per day!</p>
                    
                    <div class="payment-options" id="premium-payment-options">
                        <div class="payment-option" data-payment-method="wallet">
                            <input type="radio" id="wallet-payment" name="premium-payment-method" value="wallet">
                            <div class="payment-label">
                                <div class="payment-title">Pay from Wallet</div>
                                <div class="payment-description">Use your available balance</div>
                            </div>
                        </div>
                        
                        <div class="payment-option" data-payment-method="direct">
                            <input type="radio" id="direct-payment" name="premium-payment-method" value="direct" checked>
                            <div class="payment-label">
                                <div class="payment-title">Direct Payment</div>
                                <div class="payment-description">Pay with M-Pesa or Airtel Money</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="button" class="btn-primary" id="confirm-premium-payment">
                            <span id="confirm-premium-btn-text">Confirm Payment - KES 120</span>
                            <span class="spinner hidden" id="confirm-premium-spinner"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-screen="dashboard-screen">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-label">Dashboard</div>
            </div>
            <div class="nav-item" data-screen="earn-screen">
                <div class="nav-icon"><i class="fas fa-chart-line"></i></div>
                <div class="nav-label">Earn</div>
            </div>
            <div class="nav-item" data-screen="deposit-screen">
                <div class="nav-icon"><i class="fas fa-plus-circle"></i></div>
                <div class="nav-label">Deposit</div>
            </div>
            <div class="nav-item" data-screen="withdrawal-screen">
                <div class="nav-icon"><i class="fas fa-minus-circle"></i></div>
                <div class="nav-label">Withdraw</div>
            </div>
            <div class="nav-item" data-screen="account-screen">
                <div class="nav-icon"><i class="fas fa-user-circle"></i></div>
                <div class="nav-label">Account</div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://lqugtfzuffmtxoiljogs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxdWd0Znp1ZmZtdHhvaWxqb2dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjIwNzQsImV4cCI6MjA3OTUzODA3NH0.4_rIKGhmnJp_NlXhBYXBA4079Ewz7qZ1D4zAxfNS_eU';
        
        // PayStack Configuration - Updated with your new keys
        const PAYSTACK_PUBLIC_KEY = 'pk_live_eebdb66d551add6207fa378960dc13d2e7a0e11f';
        const PAYSTACK_SECRET_KEY = 'sk_live_7ac7ba67c118498a7efa9b09e2024c11ca87baa0';
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Application State
        let currentUser = null;
        let userProfile = null;
        let userBalance = 0;
        let transactions = [];
        let investments = [];
        let referrals = [];
        let surveyData = null;
        let assets = [
            {
                id: '1',
                name: 'Gold Investment',
                symbol: 'GOLD',
                description: 'Invest in physical gold with secure storage',
                current_apy: 1400, // KES per 24 hours
                min_deposit: 15000,
                is_active: true,
                period: '24 hours'
            },
            {
                id: '2',
                name: 'Bitcoin',
                symbol: 'BTC',
                description: 'Cryptocurrency investment with high growth potential',
                current_apy: 70, // KES per 24 hours
                min_deposit: 500,
                is_active: true,
                period: '24 hours'
            },
            {
                id: '3',
                name: 'USDT Savings',
                symbol: 'USDT',
                description: 'Stablecoin investment with consistent returns',
                current_apy: 10, // KES per 24 hours
                min_deposit: 100,
                is_active: true,
                period: '24 hours'
            },
            {
                id: '4',
                name: 'Coal Mining',
                symbol: 'COAL',
                description: 'Investment in coal mining operations',
                current_apy: 3000, // KES per 24 hours
                min_deposit: 20000,
                is_active: true,
                period: '24 hours'
            },
            {
                id: '5',
                name: 'GENZ Portfolio',
                symbol: 'GENZ',
                description: 'Curated portfolio for the next generation',
                current_apy: 25, // KES per 24 hours
                min_deposit: 200,
                is_active: true,
                period: '24 hours'
            }
        ];

        // Survey URLs
        const surveyUrls = [
            'https://form.jotform.com/253281302437047',
            'https://form.jotform.com/253281307439054',
            'https://form.jotform.com/253281414828055'
        ];

        // DOM Elements
        const authScreens = document.getElementById('auth-screens');
        const app = document.getElementById('app');
        const loginScreen = document.getElementById('login-screen');
        const registerScreen = document.getElementById('register-screen');
        const forgotPasswordScreen = document.getElementById('forgot-password-screen');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            checkAuthStatus();
            // Start real-time profit calculation
            startProfitCalculation();
        });

        // Initialize all event listeners
        function initializeEventListeners() {
            // Authentication events
            document.getElementById('show-register').addEventListener('click', function(e) {
                e.preventDefault();
                showRegisterScreen();
            });
            document.getElementById('show-login').addEventListener('click', function(e) {
                e.preventDefault();
                showLoginScreen();
            });
            document.getElementById('show-forgot-password').addEventListener('click', function(e) {
                e.preventDefault();
                showForgotPasswordScreen();
            });
            document.getElementById('show-login-from-forgot').addEventListener('click', function(e) {
                e.preventDefault();
                showLoginScreen();
            });
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);

            // Navigation events
            document.getElementById('deposit-btn').addEventListener('click', showDepositScreen);
            document.getElementById('withdraw-btn').addEventListener('click', showWithdrawalScreen);
            document.getElementById('earn-btn').addEventListener('click', showEarnScreen);
            document.getElementById('account-btn').addEventListener('click', showAccountScreen);
            document.getElementById('profile-item').addEventListener('click', showProfileScreen);
            document.getElementById('kyc-item').addEventListener('click', showKycScreen);
            document.getElementById('download-app-item').addEventListener('click', showAccountScreen);
            document.getElementById('support-item').addEventListener('click', showSupportScreen);
            document.getElementById('logout-item').addEventListener('click', handleLogout);
            document.getElementById('faq-option').addEventListener('click', showFaqScreen);

            // NEW: Refresh button
            document.getElementById('refresh-balance-btn').addEventListener('click', handleRefresh);

            // NEW: Survey buttons
            document.getElementById('take-survey-btn').addEventListener('click', showSurveyScreen);
            document.getElementById('buy-premium-btn').addEventListener('click', showPremiumPaymentScreen);
            document.getElementById('submit-survey-btn').addEventListener('click', handleSurveyCompletion);

            // NEW: Premium payment options
            document.querySelectorAll('.payment-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.payment-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                });
            });

            // NEW: Confirm premium payment
            document.getElementById('confirm-premium-payment').addEventListener('click', handlePremiumPayment);

            // NEW: Copy referral code
            document.getElementById('copy-referral').addEventListener('click', copyReferralCode);

            // Bottom navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const screenId = this.getAttribute('data-screen');
                    showScreen(screenId);
                    
                    document.querySelectorAll('.nav-item').forEach(navItem => {
                        navItem.classList.remove('active');
                    });
                    this.classList.add('active');
                });
            });

            // Form submissions
            document.getElementById('deposit-form').addEventListener('submit', handleDeposit);
            document.getElementById('withdrawal-form').addEventListener('submit', handleWithdrawal);
            document.getElementById('kyc-form').addEventListener('submit', handleKycSubmission);
            document.getElementById('profile-form').addEventListener('submit', handleProfileUpdate);

            // FAQ events
            document.querySelectorAll('.faq-question').forEach(question => {
                question.addEventListener('click', function() {
                    const item = this.parentElement;
                    item.classList.toggle('active');
                });
            });
        }

        // NEW: Handle refresh button click
        async function handleRefresh() {
            const refreshBtn = document.getElementById('refresh-balance-btn');
            refreshBtn.style.transform = 'rotate(180deg)';
            
            await loadUserData();
            
            setTimeout(() => {
                refreshBtn.style.transform = 'rotate(0deg)';
            }, 500);
            
            showNotification('Data refreshed successfully', 'success');
        }

        // NEW: Start real-time profit calculation
        function startProfitCalculation() {
            // Update profit every 30 seconds
            setInterval(updateRealTimeProfit, 30000);
        }

        // NEW: Update real-time profit with specific amounts
        function updateRealTimeProfit() {
            if (!investments.length) return;
            
            // Calculate daily earnings based on specific amounts
            const dailyEarnings = investments.reduce((sum, inv) => {
                if (inv.status === 'active') {
                    const asset = assets.find(a => a.id === inv.asset_id);
                    if (asset) {
                        // Calculate earnings based on time passed
                        const startTime = new Date(inv.start_date || inv.created_at).getTime();
                        const currentTime = new Date().getTime();
                        const hoursPassed = (currentTime - startTime) / (1000 * 60 * 60);
                        
                        // Calculate earnings for the time passed (proportional to 24 hours)
                        const earnings = (asset.current_apy * hoursPassed) / 24;
                        return sum + earnings;
                    }
                }
                return sum;
            }, 0);
            
            // Update profit text
            const profitElement = document.getElementById('profit-text');
            if (profitElement) {
                profitElement.textContent = `+ KES ${dailyEarnings.toFixed(2)} Today`;
            }
        }

        // Check if user is authenticated
        async function checkAuthStatus() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    currentUser = session.user;
                    await loadUserData();
                    showApp();
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showAuth();
            }
        }

        // Load user data from Supabase
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Load user profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileError && profileError.code !== 'PGRST116') {
                    console.error('Profile error:', profileError);
                }
                
                if (profile) {
                    userProfile = profile;
                    
                    // Set user balance from profile or default to 0
                    userBalance = profile.balance || 0;
                    
                    // Update profile picture if available - FIXED: Store in localStorage
                    if (profile.profile_picture) {
                        updateProfilePicture(profile.profile_picture);
                        localStorage.setItem('profile_picture', profile.profile_picture);
                    } else {
                        // Check if we have a stored profile picture
                        const storedPicture = localStorage.getItem('profile_picture');
                        if (storedPicture) {
                            updateProfilePicture(storedPicture);
                        }
                    }
                } else {
                    // Create default profile if it doesn't exist
                    userProfile = {
                        id: currentUser.id,
                        full_name: currentUser.email?.split('@')[0] || 'User',
                        email: currentUser.email,
                        phone_number: '',
                        kyc_verified: false,
                        kyc_status: 'not_submitted',
                        referral_code: generateReferralCode(),
                        balance: 0,
                        is_premium: false
                    };
                    
                    // Try to save the profile
                    const { error: insertError } = await supabase
                        .from('profiles')
                        .insert([userProfile]);
                    
                    if (insertError) {
                        console.error('Error creating profile:', insertError);
                    }
                }
                
                // Load referrals - FIXED: Proper referral tracking
                const { data: referralsData, error: referralsError } = await supabase
                    .from('profiles')
                    .select('id, full_name, created_at, balance')
                    .eq('referred_by', currentUser.id);
                
                if (referralsError) {
                    console.error('Referrals error:', referralsError);
                    referrals = [];
                } else {
                    referrals = referralsData || [];
                }
                
                // Load transactions
                const { data: transactionsData, error: transactionsError } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (transactionsError) {
                    console.error('Transactions error:', transactionsError);
                    transactions = [];
                } else {
                    transactions = transactionsData || [];
                }
                
                // Load investments - FIXED: Include all investments, not just active
                const { data: investmentsData, error: investmentsError } = await supabase
                    .from('investments')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (investmentsError) {
                    console.error('Investments error:', investmentsError);
                    investments = [];
                } else {
                    investments = investmentsData || [];
                }
                
                // Load survey data
                await loadSurveyData();
                
                updateUI();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading user data', 'error');
            }
        }

        // NEW: Load survey data
        async function loadSurveyData() {
            if (!currentUser) return;
            
            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];
                
                // Load survey submissions for today
                const { data: surveySubmissions, error } = await supabase
                    .from('survey_submissions')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .gte('submitted_at', today + 'T00:00:00')
                    .lte('submitted_at', today + 'T23:59:59');
                
                if (error) {
                    console.error('Survey data error:', error);
                    surveyData = {
                        submissions_today: 0,
                        total_earnings: 0
                    };
                } else {
                    // Calculate total survey earnings
                    const { data: allSubmissions } = await supabase
                        .from('survey_submissions')
                        .select('*')
                        .eq('user_id', currentUser.id);
                    
                    const totalEarnings = allSubmissions ? allSubmissions.length * 20 : 0;
                    
                    surveyData = {
                        submissions_today: surveySubmissions ? surveySubmissions.length : 0,
                        total_earnings: totalEarnings
                    };
                }
            } catch (error) {
                console.error('Error loading survey data:', error);
                surveyData = {
                    submissions_today: 0,
                    total_earnings: 0
                };
            }
        }

        // Update UI with real data
        function updateUI() {
            // Update welcome name
            document.getElementById('welcome-name').textContent = `Welcome, ${userProfile.full_name || 'User'}`;
            
            // Update balance
            document.getElementById('total-balance').textContent = `KES ${userBalance.toLocaleString()}`;
            
            // Calculate daily earnings based on specific amounts
            const dailyEarnings = investments.reduce((sum, inv) => {
                if (inv.status === 'active') {
                    const asset = assets.find(a => a.id === inv.asset_id);
                    if (asset) {
                        // Calculate earnings based on time passed
                        const startTime = new Date(inv.start_date || inv.created_at).getTime();
                        const currentTime = new Date().getTime();
                        const hoursPassed = (currentTime - startTime) / (1000 * 60 * 60);
                        
                        // Calculate earnings for the time passed (proportional to 24 hours)
                        const earnings = (asset.current_apy * hoursPassed) / 24;
                        return sum + earnings;
                    }
                }
                return sum;
            }, 0);
            
            document.getElementById('profit-text').textContent = `+ KES ${dailyEarnings.toFixed(2)} Today`;
            
            // NEW: Update enhanced stats
            updateEnhancedStats();
            
            // Update KYC verification tick
            const kycTick = document.getElementById('kyc-verified-tick');
            const userVerifiedTick = document.getElementById('user-verified-tick');
            if (userProfile && userProfile.kyc_verified) {
                kycTick.classList.remove('hidden');
                userVerifiedTick.classList.remove('hidden');
            } else {
                kycTick.classList.add('hidden');
                userVerifiedTick.classList.add('hidden');
            }
            
            // Update profile verification tick
            const profileTick = document.getElementById('profile-verified-tick');
            if (userProfile && userProfile.phone_number && userProfile.full_name) {
                profileTick.classList.remove('hidden');
            } else {
                profileTick.classList.add('hidden');
            }
            
            // Update referral code
            if (userProfile && userProfile.referral_code) {
                document.getElementById('referral-code-display').textContent = userProfile.referral_code;
            }
            
            // Update referral stats - FIXED: Proper referral earnings calculation
            document.getElementById('referrals-count').textContent = referrals.length;
            
            // Calculate referral earnings (10% of referred user's first deposit)
            const referralEarnings = referrals.reduce((sum, referral) => {
                return sum + (referral.balance * 0.1); // 10% of referral's balance
            }, 0);
            
            document.getElementById('referral-earnings').textContent = `KES ${referralEarnings.toLocaleString()}`;
            
            // Update survey stats
            if (surveyData) {
                const maxSurveys = userProfile.is_premium ? 3 : 1;
                document.getElementById('surveys-today').textContent = `${surveyData.submissions_today}/${maxSurveys}`;
                document.getElementById('survey-earnings-total').textContent = `KES ${surveyData.total_earnings}`;
                
                // Enable/disable survey button based on daily limit
                const surveyBtn = document.getElementById('take-survey-btn');
                if (surveyData.submissions_today >= maxSurveys) {
                    surveyBtn.disabled = true;
                    surveyBtn.textContent = 'Daily Limit Reached';
                } else {
                    surveyBtn.disabled = false;
                    surveyBtn.textContent = 'Take Survey';
                }
            }
            
            // Render investment plans
            renderInvestmentPlans();
            updateRecentTransactions();
            updateActiveInvestments();
        }

        // NEW: Update enhanced stats
        function updateEnhancedStats() {
            // Calculate total earnings from all sources
            const totalEarnings = transactions
                .filter(t => ['deposit', 'referral', 'survey'].includes(t.type))
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            document.getElementById('total-earnings').textContent = `KES ${totalEarnings.toLocaleString()}`;
            
            // Count active investments
            const activeInvestmentsCount = investments.filter(inv => inv.status === 'active').length;
            document.getElementById('active-investments-count').textContent = activeInvestmentsCount;
            
            // Show survey earnings
            document.getElementById('survey-earnings').textContent = `KES ${surveyData ? surveyData.total_earnings : 0}`;
            
            // Show referral count
            document.getElementById('referral-count').textContent = referrals.length;
        }

        // Update profile picture - FIXED: Store in Supabase Storage
        async function updateProfilePicture(imageUrl) {
            const profilePictureContainer = document.getElementById('profile-picture-container');
            profilePictureContainer.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'Profile Picture';
            img.className = 'profile-picture';
            profilePictureContainer.appendChild(img);
        }

        // Show authentication screens
        function showAuth() {
            authScreens.classList.remove('hidden');
            app.classList.add('hidden');
            showLoginScreen();
        }

        // Show main application
        function showApp() {
            authScreens.classList.add('hidden');
            app.classList.remove('hidden');
            showDashboardScreen();
        }

        // Show specific screen
        function showScreen(screenId) {
            // Hide all screens
            const screens = [
                'dashboard-screen', 'deposit-screen', 'withdrawal-screen', 
                'earn-screen', 'account-screen', 'profile-screen', 
                'kyc-screen', 'support-screen', 'faq-screen', 'survey-screen',
                'premium-payment-screen'
            ];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
            
            // Show the requested screen
            document.getElementById(screenId).classList.remove('hidden');
            
            // Load data for specific screens
            if (screenId === 'dashboard-screen') {
                updateUI();
            } else if (screenId === 'earn-screen') {
                renderEarnPlans();
                updateActiveInvestments();
            } else if (screenId === 'kyc-screen') {
                updateKycStatus();
            } else if (screenId === 'profile-screen') {
                populateProfileForm();
            }
        }

        // NEW: Show survey screen
        function showSurveyScreen() {
            // Select a random survey URL
            const randomSurvey = surveyUrls[Math.floor(Math.random() * surveyUrls.length)];
            document.getElementById('survey-iframe').src = randomSurvey;
            showScreen('survey-screen');
        }

        // NEW: Show premium payment screen
        function showPremiumPaymentScreen() {
            showScreen('premium-payment-screen');
        }

        // Authentication screen navigation
        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            registerScreen.classList.add('hidden');
            forgotPasswordScreen.classList.add('hidden');
        }

        function showRegisterScreen() {
            loginScreen.classList.add('hidden');
            registerScreen.classList.remove('hidden');
            forgotPasswordScreen.classList.add('hidden');
        }

        function showForgotPasswordScreen() {
            loginScreen.classList.add('hidden');
            registerScreen.classList.add('hidden');
            forgotPasswordScreen.classList.remove('hidden');
        }

        // Main screen navigation
        function showDashboardScreen() {
            showScreen('dashboard-screen');
        }

        function showDepositScreen() {
            showScreen('deposit-screen');
        }

        function showWithdrawalScreen() {
            showScreen('withdrawal-screen');
        }

        function showEarnScreen() {
            showScreen('earn-screen');
        }

        function showAccountScreen() {
            showScreen('account-screen');
        }

        function showProfileScreen() {
            showScreen('profile-screen');
        }

        function showKycScreen() {
            showScreen('kyc-screen');
        }

        function showSupportScreen() {
            showScreen('support-screen');
        }

        function showFaqScreen() {
            showScreen('faq-screen');
        }

        // Authentication handlers
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Use a simpler loading state
            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.innerHTML;
            loginBtn.innerHTML = 'Signing In... <span class="spinner"></span>';
            loginBtn.disabled = true;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                await loadUserData();
                showApp();
                showNotification('Login successful!', 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification(error.message || 'Login failed. Please try again.', 'error');
            } finally {
                // Reset button state
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const fullName = document.getElementById('register-fullname').value;
            const email = document.getElementById('register-email').value;
            const phone = document.getElementById('register-phone').value;
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('register-referral').value;
            
            if (!fullName || !email || !phone || !password) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            // Validate phone number
            const phoneRegex = /^(07\d{8}|254\d{9})$/;
            if (!phoneRegex.test(phone)) {
                showNotification('Please enter a valid phone number (07XXXXXXXX or 254XXXXXXXXX)', 'error');
                return;
            }
            
            // Use a simpler loading state
            const registerBtn = document.getElementById('register-btn');
            const originalText = registerBtn.innerHTML;
            registerBtn.innerHTML = 'Creating Account... <span class="spinner"></span>';
            registerBtn.disabled = true;
            
            try {
                // Create auth user
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                });
                
                if (authError) throw authError;
                
                // Get referred_by user ID if referral code provided
                let referredBy = null;
                if (referralCode) {
                    const { data: referrer } = await supabase
                        .from('profiles')
                        .select('id')
                        .eq('referral_code', referralCode)
                        .single();
                    
                    if (referrer) {
                        referredBy = referrer.id;
                    }
                }
                
                // Create profile
                const { error: profileError } = await supabase
                    .from('profiles')
                    .insert([
                        {
                            id: authData.user.id,
                            full_name: fullName,
                            email: email,
                            phone_number: phone,
                            referral_code: generateReferralCode(),
                            referred_by: referredBy,
                            balance: 0,
                            is_premium: false
                        }
                    ]);
                
                if (profileError) {
                    console.error('Profile creation error:', profileError);
                    // If profile creation fails, we can still proceed
                }
                
                showNotification('Account created successfully! You can now sign in.', 'success');
                showLoginScreen();
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification(error.message || 'Registration failed. Please try again.', 'error');
            } finally {
                // Reset button state
                registerBtn.innerHTML = originalText;
                registerBtn.disabled = false;
            }
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value;
            
            if (!email) {
                showNotification('Please enter your email', 'error');
                return;
            }
            
            // Use a simpler loading state
            const resetBtn = document.getElementById('reset-btn');
            const originalText = resetBtn.innerHTML;
            resetBtn.innerHTML = 'Sending... <span class="spinner"></span>';
            resetBtn.disabled = true;
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email);
                
                if (error) throw error;
                
                showNotification('Password reset link sent to your email', 'success');
                showLoginScreen();
                
            } catch (error) {
                console.error('Forgot password error:', error);
                showNotification(error.message || 'Failed to send reset link. Please try again.', 'error');
            } finally {
                // Reset button state
                resetBtn.innerHTML = originalText;
                resetBtn.disabled = false;
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                userProfile = null;
                showNotification('Logged out successfully', 'success');
                showAuth();
            } catch (error) {
                showNotification('Error logging out', 'error');
            }
        }

        // NEW: Handle premium payment with wallet or direct payment
        async function handlePremiumPayment() {
            const amount = 120; // KES 120 for premium
            const paymentMethod = document.querySelector('input[name="premium-payment-method"]:checked').value;
            
            try {
                if (paymentMethod === 'wallet') {
                    // Pay from wallet
                    if (userBalance < amount) {
                        showNotification('Insufficient balance in wallet', 'error');
                        return;
                    }
                    
                    const confirmBtn = document.getElementById('confirm-premium-payment');
                    const originalText = confirmBtn.innerHTML;
                    confirmBtn.innerHTML = 'Processing... <span class="spinner"></span>';
                    confirmBtn.disabled = true;
                    
                    // Deduct from wallet
                    userBalance -= amount;
                    
                    // Update profile balance in database
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ 
                            balance: userBalance,
                            is_premium: true
                        })
                        .eq('id', currentUser.id);
                    
                    if (updateError) {
                        console.error('Balance update error:', updateError);
                        showNotification('Error processing payment', 'error');
                        return;
                    }
                    
                    // Record transaction
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: currentUser.id,
                                type: 'premium_purchase',
                                amount: amount,
                                status: 'completed',
                                payment_method: 'wallet',
                                metadata: { 
                                    payment_type: 'premium',
                                    method: 'wallet'
                                }
                            }
                        ]);
                    
                    if (transactionError) {
                        console.error('Transaction error:', transactionError);
                    }
                    
                    userProfile.is_premium = true;
                    showNotification('Premium activated successfully! You can now take up to 3 surveys per day.', 'success');
                    updateUI();
                    showEarnScreen();
                    
                    // Reset button state
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    
                } else {
                    // Direct payment with PayStack
                    const handler = PaystackPop.setup({
                        key: PAYSTACK_PUBLIC_KEY,
                        email: currentUser.email,
                        amount: amount * 100, // PayStack expects amount in kobo
                        currency: 'KES',
                        metadata: {
                            user_id: currentUser.id,
                            payment_type: 'premium'
                        },
                        callback: function(response) {
                            handlePremiumPaymentCallback(response, amount);
                        },
                        onClose: function() {
                            showNotification('Payment window closed', 'warning');
                        }
                    });
                    
                    handler.openIframe();
                }
                
            } catch (error) {
                console.error('Error processing premium payment:', error);
                showNotification('Error processing payment: ' + error.message, 'error');
            }
        }

        // NEW: Handle premium payment callback
        async function handlePremiumPaymentCallback(response, amount) {
            try {
                if (response.status === 'success') {
                    // Payment was successful
                    // Create transaction record
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: currentUser.id,
                                type: 'premium_purchase',
                                amount: amount,
                                status: 'completed',
                                payment_method: 'paystack',
                                paystack_reference: response.reference,
                                metadata: { 
                                    paystack_response: response,
                                    payment_type: 'premium'
                                }
                            }
                        ]);
                    
                    if (transactionError) {
                        console.error('Transaction error:', transactionError);
                    }
                    
                    // Update user profile to premium
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ is_premium: true })
                        .eq('id', currentUser.id);
                    
                    if (updateError) {
                        console.error('Profile update error:', updateError);
                    } else {
                        userProfile.is_premium = true;
                        showNotification('Premium activated successfully! You can now take up to 3 surveys per day.', 'success');
                        updateUI();
                        showEarnScreen();
                    }
                } else {
                    showNotification('Payment failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error handling payment callback:', error);
                showNotification('Error processing payment', 'error');
            }
        }

        // NEW: Handle survey completion
        async function handleSurveyCompletion() {
            const submitBtn = document.getElementById('submit-survey-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'Processing... <span class="spinner"></span>';
            submitBtn.disabled = true;
            
            try {
                // Record survey submission
                const { error: surveyError } = await supabase
                    .from('survey_submissions')
                    .insert([
                        {
                            user_id: currentUser.id,
                            amount: 20,
                            status: 'completed'
                        }
                    ]);
                
                if (surveyError) {
                    console.error('Survey submission error:', surveyError);
                    showNotification('Error recording survey submission', 'error');
                    return;
                }
                
                // Update user balance
                userBalance += 20;
                
                // Update profile balance in database
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ balance: userBalance })
                    .eq('id', currentUser.id);
                
                if (updateError) {
                    console.error('Balance update error:', updateError);
                }
                
                // Record transaction
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert([
                        {
                            user_id: currentUser.id,
                            type: 'survey',
                            amount: 20,
                            status: 'completed',
                            metadata: { survey_type: 'general' }
                        }
                    ]);
                
                if (transactionError) {
                    console.error('Transaction error:', transactionError);
                }
                
                // Reload survey data
                await loadSurveyData();
                
                showNotification('Survey completed! KES 20 has been added to your balance.', 'success');
                showEarnScreen();
                
            } catch (error) {
                console.error('Error processing survey:', error);
                showNotification('Error processing survey completion', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Transaction handlers
        async function handleDeposit(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
            
            if (!amount || amount < 10) {
                showNotification('Minimum deposit is KES 10', 'error');
                return;
            }
            
            // Use a simpler loading state
            const depositBtn = document.getElementById('deposit-submit-btn');
            const originalText = depositBtn.innerHTML;
            depositBtn.innerHTML = 'Processing... <span class="spinner"></span>';
            depositBtn.disabled = true;
            
            try {
                // Use PayStack for payment processing with proper callback function
                const handler = PaystackPop.setup({
                    key: PAYSTACK_PUBLIC_KEY,
                    email: currentUser.email,
                    amount: amount * 100, // PayStack expects amount in kobo
                    currency: 'KES',
                    metadata: {
                        user_id: currentUser.id,
                        payment_method: paymentMethod,
                        custom_fields: [
                            {
                                display_name: "User ID",
                                variable_name: "user_id",
                                value: currentUser.id
                            }
                        ]
                    },
                    callback: function(response) {
                        // This is the callback function that will be called after payment
                        handlePaystackCallback(response, amount, paymentMethod);
                    },
                    onClose: function() {
                        showNotification('Payment window closed', 'warning');
                        // FIXED: Reset button state when payment window is closed
                        depositBtn.innerHTML = originalText;
                        depositBtn.disabled = false;
                    }
                });
                
                handler.openIframe();
                
            } catch (error) {
                console.error('Error processing deposit:', error);
                showNotification('Error processing deposit: ' + error.message, 'error');
                // Reset button state
                depositBtn.innerHTML = originalText;
                depositBtn.disabled = false;
            }
        }

        // Handle PayStack callback - FIXED: Properly reset button state
        async function handlePaystackCallback(response, amount, paymentMethod) {
            try {
                // Reset button state regardless of outcome
                const depositBtn = document.getElementById('deposit-submit-btn');
                depositBtn.innerHTML = 'Proceed to Payment';
                depositBtn.disabled = false;
                
                if (response.status === 'success') {
                    // Payment was successful
                    // Create transaction record
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: currentUser.id,
                                type: 'deposit',
                                amount: amount,
                                status: 'completed',
                                payment_method: paymentMethod,
                                paystack_reference: response.reference,
                                metadata: { 
                                    paystack_response: response,
                                    phone: userProfile.phone_number
                                }
                            }
                        ]);
                    
                    if (transactionError) {
                        console.error('Transaction error:', transactionError);
                        // Continue anyway for demo
                    }
                    
                    // Update user balance
                    userBalance += amount;
                    
                    // Update profile balance in database
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({ balance: userBalance })
                        .eq('id', currentUser.id);
                    
                    if (updateError) {
                        console.error('Balance update error:', updateError);
                    }
                    
                    showNotification(`Deposit of KES ${amount.toLocaleString()} successful!`, 'success');
                    showDashboardScreen();
                } else {
                    showNotification('Payment failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error handling payment callback:', error);
                showNotification('Error processing payment', 'error');
            }
        }

        async function handleWithdrawal(e) {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            const phone = document.getElementById('withdrawal-phone').value;
            
            if (!amount || amount < 100) {
                showNotification('Minimum withdrawal is KES 100', 'error');
                return;
            }
            
            if (amount > userBalance) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            // Validate phone number
            const phoneRegex = /^(07\d{8}|254\d{9})$/;
            if (!phoneRegex.test(phone)) {
                showNotification('Please enter a valid phone number (07XXXXXXXX or 254XXXXXXXXX)', 'error');
                return;
            }
            
            // Check KYC status
            if (!userProfile || !userProfile.kyc_verified) {
                showNotification('KYC verification required for withdrawals', 'error');
                showKycScreen();
                return;
            }
            
            // Use a simpler loading state
            const withdrawalBtn = document.getElementById('withdrawal-submit-btn');
            const originalText = withdrawalBtn.innerHTML;
            withdrawalBtn.innerHTML = 'Processing... <span class="spinner"></span>';
            withdrawalBtn.disabled = true;
            
            try {
                // Create withdrawal request
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert([
                        {
                            user_id: currentUser.id,
                            type: 'withdrawal',
                            amount: amount,
                            status: 'pending',
                            payment_method: 'mobile_money',
                            metadata: { phone: phone }
                        }
                    ]);
                
                if (transactionError) {
                    console.error('Transaction error:', transactionError);
                    // Continue anyway for demo
                }
                
                // Update user balance
                userBalance -= amount;
                
                // Update profile balance in database
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ balance: userBalance })
                    .eq('id', currentUser.id);
                
                if (updateError) {
                    console.error('Balance update error:', updateError);
                }
                
                showNotification('Withdrawal request submitted. It will be processed within 24 hours.', 'success');
                showDashboardScreen();
                
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                showNotification('Error processing withdrawal', 'error');
            } finally {
                // Reset button state
                withdrawalBtn.innerHTML = originalText;
                withdrawalBtn.disabled = false;
            }
        }

        async function handleKycSubmission(e) {
            e.preventDefault();
            const idType = document.getElementById('kyc-id-type').value;
            const idNumber = document.getElementById('kyc-id-number').value;
            const frontImage = document.getElementById('kyc-front').files[0];
            const backImage = document.getElementById('kyc-back').files[0];
            const selfieImage = document.getElementById('kyc-selfie').files[0];
            
            if (!idType || !idNumber || !frontImage || !selfieImage) {
                showNotification('Please fill all required fields', 'error');
                return;
            }
            
            // Use a simpler loading state
            const kycBtn = document.getElementById('kyc-submit-btn');
            const originalText = kycBtn.innerHTML;
            kycBtn.innerHTML = 'Submitting... <span class="spinner"></span>';
            kycBtn.disabled = true;
            
            try {
                // Upload KYC documents to Supabase Storage
                const frontImageUrl = await uploadKycDocument(frontImage, 'kyc-documents', `front_${currentUser.id}_${Date.now()}`);
                const backImageUrl = backImage ? await uploadKycDocument(backImage, 'kyc-documents', `back_${currentUser.id}_${Date.now()}`) : null;
                const selfieImageUrl = await uploadKycDocument(selfieImage, 'kyc-documents', `selfie_${currentUser.id}_${Date.now()}`);
                
                // Update profile KYC status
                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({ 
                        kyc_status: 'pending',
                        kyc_verified: false
                    })
                    .eq('id', currentUser.id);
                
                if (profileError) {
                    console.error('Profile update error:', profileError);
                    // Continue anyway for demo
                }
                
                // Create KYC verification record
                const { error: kycError } = await supabase
                    .from('kyc_verifications')
                    .insert([
                        {
                            user_id: currentUser.id,
                            id_type: idType,
                            id_number: idNumber,
                            front_image_url: frontImageUrl,
                            back_image_url: backImageUrl,
                            selfie_image_url: selfieImageUrl,
                            status: 'pending'
                        }
                    ]);
                
                if (kycError) {
                    console.error('KYC submission error:', kycError);
                    // Continue anyway for demo
                }
                
                userProfile.kyc_status = 'pending';
                userProfile.kyc_verified = false;
                updateKycStatus();
                showNotification('KYC documents submitted successfully. Verification may take 24-48 hours.', 'success');
                
            } catch (error) {
                console.error('Error submitting KYC:', error);
                showNotification('Error submitting KYC documents', 'error');
            } finally {
                // Reset button state
                kycBtn.innerHTML = originalText;
                kycBtn.disabled = false;
            }
        }

        // NEW: Upload KYC document to Supabase Storage
        async function uploadKycDocument(file, bucketName, fileName) {
            const { data, error } = await supabase.storage
                .from(bucketName)
                .upload(fileName, file);
            
            if (error) {
                console.error('Error uploading document:', error);
                throw error;
            }
            
            // Get public URL
            const { data: { publicUrl } } = supabase.storage
                .from(bucketName)
                .getPublicUrl(fileName);
            
            return publicUrl;
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            const fullName = document.getElementById('profile-fullname').value;
            const phone = document.getElementById('profile-phone').value;
            const profilePicture = document.getElementById('profile-picture').files[0];
            
            if (!fullName || !phone) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            // Validate phone number
            const phoneRegex = /^(07\d{8}|254\d{9})$/;
            if (!phoneRegex.test(phone)) {
                showNotification('Please enter a valid phone number (07XXXXXXXX or 254XXXXXXXXX)', 'error');
                return;
            }
            
            // Use a simpler loading state
            const profileBtn = document.getElementById('profile-submit-btn');
            const originalText = profileBtn.innerHTML;
            profileBtn.innerHTML = 'Updating... <span class="spinner"></span>';
            profileBtn.disabled = true;
            
            try {
                // If profile picture is uploaded, upload it to Supabase Storage
                let profilePictureUrl = userProfile.profile_picture;
                if (profilePicture) {
                    profilePictureUrl = await uploadProfilePicture(profilePicture);
                    updateProfilePicture(profilePictureUrl);
                }
                
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        phone_number: phone,
                        profile_picture: profilePictureUrl,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('Profile update error:', error);
                    // Continue anyway for demo
                }
                
                userProfile.full_name = fullName;
                userProfile.phone_number = phone;
                userProfile.profile_picture = profilePictureUrl;
                showNotification('Profile updated successfully', 'success');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error updating profile', 'error');
            } finally {
                // Reset button state
                profileBtn.innerHTML = originalText;
                profileBtn.disabled = false;
            }
        }

        // NEW: Upload profile picture to Supabase Storage
        async function uploadProfilePicture(file) {
            const fileName = `profile_${currentUser.id}_${Date.now()}`;
            
            const { data, error } = await supabase.storage
                .from('profile-pictures')
                .upload(fileName, file);
            
            if (error) {
                console.error('Error uploading profile picture:', error);
                throw error;
            }
            
            // Get public URL
            const { data: { publicUrl } } = supabase.storage
                .from('profile-pictures')
                .getPublicUrl(fileName);
            
            return publicUrl;
        }

        // Investment functionality - FIXED: Proper investment recording
        async function handleInvestment(assetId, amount) {
            const asset = assets.find(a => a.id === assetId);
            
            if (!asset) {
                showNotification('Invalid asset selected', 'error');
                return;
            }
            
            if (amount < asset.min_deposit) {
                showNotification(`Minimum investment for ${asset.name} is KES ${asset.min_deposit.toLocaleString()}`, 'error');
                return;
            }
            
            if (amount > userBalance) {
                showNotification('Insufficient balance', 'error');
                return;
            }
            
            try {
                // Create investment
                const { error: investmentError } = await supabase
                    .from('investments')
                    .insert([
                        {
                            user_id: currentUser.id,
                            asset_id: assetId,
                            asset_name: asset.name,
                            amount: amount,
                            apy: asset.current_apy,
                            status: 'active',
                            start_date: new Date().toISOString()
                        }
                    ]);
                
                if (investmentError) {
                    console.error('Investment error:', investmentError);
                    // Continue anyway for demo
                }
                
                // Record transaction
                const { error: transactionError } = await supabase
                    .from('transactions')
                    .insert([
                        {
                            user_id: currentUser.id,
                            type: 'investment',
                            amount: amount,
                            status: 'completed',
                            metadata: { asset_name: asset.name }
                        }
                    ]);
                
                if (transactionError) {
                    console.error('Transaction error:', transactionError);
                    // Continue anyway for demo
                }
                
                // Update user balance
                userBalance -= amount;
                
                // Update profile balance in database
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ balance: userBalance })
                    .eq('id', currentUser.id);
                
                if (updateError) {
                    console.error('Balance update error:', updateError);
                }
                
                // Reload data
                await loadUserData();
                showNotification(`Successfully invested KES ${amount.toLocaleString()} in ${asset.name}`, 'success');
                
            } catch (error) {
                console.error('Error processing investment:', error);
                showNotification('Error processing investment', 'error');
            }
        }

        // Utility functions
        function generateReferralCode() {
            return 'ZENT' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function renderInvestmentPlans() {
            const container = document.getElementById('investment-plans-container');
            
            if (!assets.length) {
                container.innerHTML = '<div class="text-center p-16">Loading investment plans...</div>';
                return;
            }
            
            container.innerHTML = assets.map(asset => `
                <div class="plan-card">
                    <div class="plan-header">
                        <div class="plan-name">${asset.name}</div>
                        <div class="plan-apy">KES ${asset.current_apy}/24h</div>
                    </div>
                    <div class="plan-details">
                        <p>${asset.description}</p>
                        <div class="plan-minimum">Minimum: KES ${asset.min_deposit.toLocaleString()}</div>
                    </div>
                    <button class="invest-btn" onclick="handleInvestment('${asset.id}', ${asset.min_deposit})" 
                            ${userBalance < asset.min_deposit ? 'disabled' : ''}>
                        Invest KES ${asset.min_deposit.toLocaleString()}
                    </button>
                </div>
            `).join('');
        }

        function renderEarnPlans() {
            const container = document.getElementById('earn-plans-container');
            renderInvestmentPlans(); // Reuse the same function
        }

        function updateRecentTransactions() {
            const container = document.getElementById('recent-transactions');
            
            if (transactions.length === 0) {
                container.innerHTML = '<div class="text-center p-16">No recent transactions</div>';
                return;
            }
            
            container.innerHTML = transactions.map(transaction => {
                const isPositive = transaction.type === 'deposit' || transaction.type === 'referral' || transaction.type === 'survey';
                const icon = getTransactionIcon(transaction.type);
                const amountClass = isPositive ? 'amount-positive' : 'amount-negative';
                const sign = isPositive ? '+' : '-';
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon">${icon}</div>
                            <div class="transaction-details">
                                <div class="transaction-title">${getTransactionDescription(transaction)}</div>
                                <div class="transaction-date">${formatDate(transaction.created_at)}</div>
                            </div>
                        </div>
                        <div class="transaction-amount ${amountClass}">
                            ${sign} KES ${parseFloat(transaction.amount).toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateActiveInvestments() {
            const container = document.getElementById('active-investments');
            
            // FIXED: Filter only active investments
            const activeInvestments = investments.filter(inv => inv.status === 'active');
            
            if (activeInvestments.length === 0) {
                container.innerHTML = '<div class="text-center p-16">No active investments</div>';
                return;
            }
            
            container.innerHTML = activeInvestments.map(investment => {
                const asset = assets.find(a => a.id === investment.asset_id) || { name: investment.asset_name || 'Unknown Asset' };
                const dailyEarnings = investment.apy; // KES per 24 hours
                
                return `
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-icon"><i class="fas fa-chart-line"></i></div>
                            <div class="transaction-details">
                                <div class="transaction-title">${asset.name}</div>
                                <div class="transaction-date">Started ${formatDate(investment.start_date || investment.created_at)}</div>
                            </div>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-title">KES ${parseFloat(investment.amount).toLocaleString()}</div>
                            <div class="transaction-date">Earns: KES ${dailyEarnings}/day</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateKycStatus() {
            const container = document.getElementById('kyc-status');
            const kycFormContainer = document.getElementById('kyc-form-container');
            let statusHtml = '';
            
            const kycVerified = userProfile && userProfile.kyc_verified;
            const kycStatus = userProfile ? userProfile.kyc_status : 'not_submitted';
            
            if (kycVerified) {
                statusHtml = `
                    <div class="card" style="background-color: #e8f5e8; border-left: 4px solid var(--success);">
                        <div class="section-header">
                            <div class="section-title">KYC Verified</div>
                        </div>
                        <p>Your identity has been successfully verified. No further action required.</p>
                    </div>
                `;
                // Hide KYC form if already verified
                kycFormContainer.classList.add('hidden');
            } else if (kycStatus === 'pending') {
                statusHtml = `
                    <div class="card" style="background-color: #fff3cd; border-left: 4px solid var(--warning);">
                        <div class="section-header">
                            <div class="section-title">KYC Under Review</div>
                        </div>
                        <p>Your documents are being reviewed. This may take 24-48 hours.</p>
                    </div>
                `;
                // Hide KYC form if pending
                kycFormContainer.classList.add('hidden');
            } else {
                statusHtml = `
                    <div class="card" style="background-color: #f8d7da; border-left: 4px solid var(--danger);">
                        <div class="section-header">
                            <div class="section-title">KYC Not Verified</div>
                        </div>
                        <p>Please complete KYC verification to enable withdrawals.</p>
                    </div>
                `;
                // Show KYC form if not submitted
                kycFormContainer.classList.remove('hidden');
            }
            
            container.innerHTML = statusHtml;
        }

        function populateProfileForm() {
            if (!userProfile) return;
            
            document.getElementById('profile-fullname').value = userProfile.full_name || '';
            document.getElementById('profile-email').value = userProfile.email || '';
            document.getElementById('profile-phone').value = userProfile.phone_number || '';
        }

        function copyReferralCode() {
            const codeInput = document.getElementById('referral-code-display');
            const textArea = document.createElement('textarea');
            textArea.value = codeInput.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Referral code copied to clipboard', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-icon">${getNotificationIcon(type)}</div>
                <div class="notification-message">${message}</div>
                <div class="notification-close">&times;</div>
            `;
            
            document.getElementById('notification-container').appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
            
            // Close button functionality
            notification.querySelector('.notification-close').addEventListener('click', function() {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            });
        }

        // Helper functions
        function getTransactionIcon(type) {
            const icons = {
                deposit: '',
                withdrawal: '',
                investment: '',
                referral: '',
                survey: '',
                premium_purchase: ''
            };
            return icons[type] || '';
        }

        function getTransactionDescription(transaction) {
            switch (transaction.type) {
                case 'deposit':
                    return `Deposit via ${transaction.payment_method || 'payment'}`;
                case 'withdrawal':
                    return 'Withdrawal Request';
                case 'investment':
                    return `Investment in ${transaction.metadata?.asset_name || 'Asset'}`;
                case 'referral':
                    return 'Referral Earnings';
                case 'survey':
                    return 'Survey Earnings';
                case 'premium_purchase':
                    return 'Premium Subscription';
                default:
                    return 'Transaction';
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            return icons[type] || '';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Make handleInvestment available globally
        window.handleInvestment = handleInvestment;
    </script>
</body>
</html>
